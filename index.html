<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hook's Playground</title>
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  
    <style type="text/css">
      .output-content {
        background-color: #FAFAFA;
        color: #0C1E3F;
        font-family: monospace;
        font-size: medium;
        padding: 10px;
        width: 500px;
        height: 300px;
        overflow: scroll;
      }
    </style>
  
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img src="resource/logo.png" alt="Logo" width="30" height="24">
        </a>
        <div class="fw-lighter">
          <div class="me-auto mb-2 mb-lg-0"></div>
          <div>Version 0.1.0</div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row align-items-start">

        <div class="col">

          <div class="container-fluid">
            <div class="row" style="margin-top: 1rem; margin-bottom: 1rem">
              <div class="col font-monospace">
                Source
              </div>
              <div class="col">
              </div>
              <div class="col">
                <div class="dropdown text-end">
                  <button id="samples" class="btn text-bg-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Samples
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="selectSample(0)">Binary search</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(1)">Factorial</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(2)">Fibonnaci</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(3)">Fizz buzz</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(4)">Hello, world!</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(5)">Knuth shuffle</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(6)">Mandelbrot set</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(7)">Quicksort</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(8)">Rule 110</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(9)">Tower of Hanoi</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div id="source" style="height: 100vh"></div>
              </div>
            </div>
          </div>

        </div>

        <div class="col">

          <div class="container-fluid">
            <div class="row" style="margin-top: 1rem; margin-bottom: 1rem">
              <div class="col font-monospace">
                Output
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div>
                  <pre id="output" class="output-content" style="height: 100vh; width: 45vw"></pre>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>

    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="node_modules/monaco-editor/min/vs/loader.js"></script>

    <script>
      function getTokensProvider() {
        return {
          defaultToken: 'invalid',

          keywords: [
              'as',
              'break',
              'continue',
              'del',
              'do',
              'else',
              'false',
              'fn',
              'for',
              'foreach',
              'from',
              'if',
              'if!',
              'in',
              'loop',
              'match',
              'mut',
              'nil',
              'return',
              'struct',
              'true',
              'use',
              'val',
              'while',
              'while!',
          ],

          typeKeywords: [],

          operators: [
              '..',
              '.',
              '|=',
              '||',
              '|',
              '^=',
              '^',
              '&=',
              '&&',
              '&',
              '=>',
              '==',
              '=',
              '!=',
              '!',
              '>=',
              '>>=',
              '>>',
              '>',
              '<=',
              '<<=',
              '<<',
              '<',
              '+=',
              '++',
              '+',
              '-=',
              '--',
              '-',
              '*=',
              '*',
              '/=',
              '/',
              '~/=',
              '~/',
              '~',
              '%=',
              '%',
          ],

          symbols: /[=><!~?:&|+\-*/^%]+/,

          escapes: /\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,

          tokenizer: {
              root: [
                  // identifiers and keywords
                  [
                      /[a-z_$][\w$]*/,
                      {
                          cases: {
                              '@typeKeywords': 'keyword',
                              '@keywords': 'keyword',
                              '@default': 'identifier',
                          },
                      },
                  ],

                  [/[A-Z][\w$]*/, 'type.identifier'], // to show class names nicely

                  // whitespace
                  {include: '@whitespace'},

                  // delimiters and operators
                  [/[{}()[\]]/, '@brackets'],
                  [/[<>](?!@symbols)/, '@brackets'],
                  [
                      /@symbols/,
                      {
                          cases: {
                              '@operators': 'operator',
                              '@default': '',
                          },
                      },
                  ],

                  // numbers
                  [/\d*\.\d+([eE][-+]?\d+)?[fFdD]?/, 'number.float'],
                  [/0[xX][0-9a-fA-F_]*[0-9a-fA-F][Ll]?/, 'number.hex'],
                  [/0o[0-7_]*[0-7][Ll]?/, 'number.octal'],
                  [/0[bB][0-1_]*[0-1][Ll]?/, 'number.binary'],
                  [/\d+/, 'number'],

                  // delimiter: after number because of .\d floats
                  [/[;,.]/, 'delimiter'],

                  // strings
                  [/"([^"\\]|\\.)*$/, 'string.invalid'], // non-teminated string
                  [/c?\\\\.*$/, 'string'],
                  [/c?"/, 'string', '@string'],

                  // characters
                  [/'[^\\']'/, 'string'],
                  [/(')(@escapes)(')/, ['string', 'string.escape', 'string']],
                  [/'/, 'string.invalid'],
              ],

              whitespace: [
                  [/[ \r\n]+/, 'white'],
                  [/\/\*/, 'comment', '@comment'],
                  [/\/\+/, 'comment', '@comment'],
                  [/\/\/.*$/, 'comment'],
                  [/\t/, 'comment.invalid'],
              ],

              comment: [
                  [/[^/*]+/, 'comment'],
                  [/\/\*/, 'comment.invalid'],
                  [/[/*]/, 'comment'],
              ],

              string: [
                  [/[^\\"]+/, 'string'],
                  [/@escapes/, 'string.escape'],
                  [/\\./, 'string.escape.invalid'],
                  [/"/, 'string', '@pop'],
              ],
          },
        };
      }

      var samples = [];

      samples.push("\/\/ Binary search\n"
        + "\n"
        + "fn binary_search(arr, key) {\n"
        + "  mut low = 0;\n"
        + "  mut high = len(arr) - 1;\n"
        + "  while (low <= high) {\n"
        + "    val middle = to_int((low + high) / 2);\n"
        + "    val cmp = compare(key, arr[middle]);\n"
        + "    if (cmp > 0) {\n"
        + "      low = middle + 1;\n"
        + "      continue;\n"
        + "    }\n"
        + "    if (cmp < 0) {\n"
        + "      high = middle - 1;\n"
        + "      continue;\n"
        + "    }\n"
        + "    return middle;\n"
        + "  }\n"
        + "  return -1;\n"
        + "}\n"
        + "\n"
        + "val arr = [ -1, 0, 3, 5, 9, 12 ];\n"
        + "println(binary_search(arr, 9));");

      samples.push("\/\/ Factorial\n"
        + "\n"
        + "fn factorial(n) {\n"
        + "  if (n == 0)\n"
        + "    return 1;\n"
        + "  return n * factorial(n - 1);\n"
        + "}\n"
        + "\n"
        + "println(factorial(8));");

      samples.push("\/\/ Fibonnaci\n"
        + "\n"
        + "fn fibonnaci(n) {\n"
        + "  if (n < 2)\n"
        + "    return n;\n"
        + "  return fibonnaci(n - 1) + fibonnaci(n - 2);\n"
        + "}\n"
        + "\n"
        + "println(fibonnaci(8));");

      samples.push("\/\/ Fizz buzz\n"
        + "\n"
        + "foreach (i in 1 .. 10) {\n"
        + "  if (i % 3 == 0 && i % 5 == 0) {\n"
        + "    println(\"FizzBuzz\");\n"
        + "    continue;\n"
        + "  }\n"
        + "  if (i % 3 == 0) {\n"
        + "    println(\"Fizz\");\n"
        + "    continue;\n"
        + "  }\n"
        + "  if (i % 5 == 0) {\n"
        + "    println(\"Buzz\");\n"
        + "    continue;\n"
        + "  }\n"
        + "  println(i);\n"
        + "}");

      samples.push("\/\/ Hello, world\n"
        + "\n"
        + "println(\"Hello, world!\");");

      samples.push("\/\/ Knuth shuffle\n"
        + "\n"
        + "use { random } from math;\n"
        + "\n"
        + "fn shuffle(mut arr) {\n"
        + "  val n = len(arr);\n"
        + "  for (mut i = n - 1; i >= 0; i -= 1) {\n"
        + "    val j = to_int(random() * (i - 1));\n"
        + "    val tmp = arr[i];\n"
        + "    arr[i] = arr[j];\n"
        + "    arr[j] = tmp;\n"
        + "  }\n"
        + "  return arr;\n"
        + "}\n"
        + "\n"
        + "val arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n"
        + "println(shuffle(arr));");

      samples.push("\/\/ Mandelbrot set\n"
        + "\n"
        + "use { floor } from math;\n"
        + "val pixels = [\" \", \".\", \":\", \";\", \"+\", \"=\", \"x\", \"X\", \"$\", \"&\"];\n"
        + "\n"
        + "val y_min = -0.2;\n"
        + "val y_max = 0.1;\n"
        + "val x_min = -1.5;\n"
        + "val x_max = -1.1;\n"
        + "\n"
        + "for (mut y_pixel = 0; y_pixel < 24; y_pixel++) {\n"
        + "  val y = (y_pixel / 24) * (y_max - y_min) + y_min;\n"
        + "  for (mut x_pixel = 0; x_pixel < 80; x_pixel++) {\n"
        + "    val x = (x_pixel / 79) * (x_max - x_min) + x_min;\n"
        + "    mut pixel = \" \";\n"
        + "    mut x0 = x;\n"
        + "    mut y0 = y;\n"
        + "    for (mut iter = 0; iter < 80; iter++) {\n"
        + "      mut x1 = (x0 * x0) - (y0 * y0);\n"
        + "      mut y1 = 2 * x0 * y0;\n"
        + "      x1 = x1 + x;\n"
        + "      y1 = y1 + y;\n"
        + "      x0 = x1;\n"
        + "      y0 = y1;\n"
        + "      val d = (x0 * x0) + (y0 * y0);\n"
        + "      if (d > 4) {\n"
        + "        pixel = pixels[floor(iter / 8)];\n"
        + "        break;\n"
        + "      }\n"
        + "    }\n"
        + "    print(pixel);\n"
        + "  }\n"
        + "  println(\"\");\n"
        + "}");

      samples.push("\/\/ Quicksort\n"
        + "\n"
        + "fn sort(mut arr) {\n"
        + "  val n = len(arr);\n"
        + "  if (n <= 1)\n"
        + "    return arr;\n"
        + "  val pivot = arr[0];\n"
        + "  mut left = []; \n"
        + "  mut right = [];\n"
        + "  for (mut i = 1; i < n; i++) {\n"
        + "    if (arr[i] < pivot)\n"
        + "      left[] = arr[i];\n"
        + "    else\n"
        + "      right[] = arr[i];\n"
        + "  }\n"
        + "  arr = sort(left);\n"
        + "  arr[] = pivot;\n"
        + "  arr += sort(right);\n"
        + "  return arr;\n"
        + "}\n"
        + "\n"
        + "println(sort([5, 2, 7, 3, 0, 1, 4, 6]));");

      samples.push("\/\/ Rule 110\n"
        + "\n"
        + "val size = 50;\n"
        + "mut prev = [];\n"
        + "mut i;\n"
        + "\n"
        + "i = 0;\n"
        + "while (i < size - 1) {\n"
        + "  prev[] = false;\n"
        + "  i++;\n"
        + "}\n"
        + "prev[] = true;\n"
        + "\n"
        + "fn calc(p, i) {\n"
        + "  val prev = p[i - 1];\n"
        + "  val curr = p[i];\n"
        + "  val next = p[i + 1];\n"
        + "  if (prev && curr && next) {\n"
        + "    return false;\n"
        + "  }\n"
        + "  if (prev && curr && !next) {\n"
        + "    return true;\n"
        + "  }\n"
        + "  if (prev && !curr && next) {\n"
        + "    return true;\n"
        + "  }\n"
        + "  if (prev && !curr && !next) {\n"
        + "    return false;\n"
        + "  }\n"
        + "  if (!prev && curr && next) {\n"
        + "    return true;\n"
        + "  }\n"
        + "  if (!prev && curr && !next) {\n"
        + "    return true;\n"
        + "  }\n"
        + "  if (!prev && !curr && next) {\n"
        + "    return true;\n"
        + "  }\n"
        + "  return false;\n"
        + "}\n"
        + "\n"
        + "i = 0;\n"
        + "while (i < size) {\n"
        + "  mut line = [false];\n"
        + "  mut j;\n"
        + "  j  = 1;\n"
        + "  while (j < size - 1) {\n"
        + "    line[] = calc(prev, j);\n"
        + "    j++;\n"
        + "  }\n"
        + "  line[] = false;\n"
        + "  mut output = \"\";\n"
        + "  j = 0;\n"
        + "  while (j < size) {\n"
        + "    output += if (line[j]) \"*\" else \" \";\n"
        + "    j++;\n"
        + "  }\n"
        + "  println(output);\n"
        + "  prev = line;\n"
        + "  i++;\n"
        + "}");

      samples.push("\/\/ Tower of Hanoi\n"
        + "\n"
        + "fn hanoi(n, src, dest, aux) {\n"
        + "  if (n == 1) {\n"
        + "    println(\"Move disk 1 from rod \" + src + \" to rod \" + dest + \".\");\n"
        + "    return;\n"
        + "  }\n"
        + "  hanoi(n - 1, src, aux, dest);\n"
        + "  println(\"Move disk \" + to_string(n) + \" from rod \" + src + \" to rod \" + dest + \".\");\n"
        + "  hanoi(n-1, aux, dest, src);\n"
        + "}\n"
        + "\n"
        + "val n = 4;\n"
        + "hanoi(n, \"A\", \"C\", \"B\");");

      var selectSample;

      function prepareRequestBody(source) {
        return {
          source: source,
          options: {
            userArguments: "",
            compilerOptions: {
              skipAsm: true
            },
            filters: {
              binaryObject: false,
              binary: false,
              execute: true,
              intel: true,
              demangle: true,
              labels: false,
              directives: false,
              commentOnly: false,
              trim: false
            },
            tools: [
            ],
            libraries: [
            ]
          },
          lang: "hook",
          files: [
          ],
          bypassCache: false,
          allowStoreCodeDebug: true
        };
      }

      function handleResponseBody(data) {
        const execResult = data.execResult;
        const out = execResult.code == 0 ? execResult.stdout : execResult.stderr;
        let text = "";
        for (let i = 0; i < out.length; i++) {
          const line = out[i];
          text += `${line.text}\n`;
        }
        return text;
      }

      function doRequest(body, callback) {
        const url = "https://godbolt.org/api/compiler/hook010/compile";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(body)
        })
          .then(response => response.json())
          .then(data => callback(data))
          .catch(error => console.error(error));
      }

      function evalutate(source) {
        const body = prepareRequestBody(source);
        doRequest(body, function(data) {
          const text = handleResponseBody(data);
          const output = document.getElementById("output");
          output.innerHTML = text;
        });
      }

      require.config({
        paths: {
          vs: "node_modules/monaco-editor/min/vs"
        }
      });

      require(["vs/editor/editor.main"], function () {

        monaco.languages.register({ id: "hook" });
        monaco.languages.setMonarchTokensProvider("hook", getTokensProvider());

        var editor = monaco.editor.create(document.getElementById("source"), {
          language: "hook"
        });

        editor.onDidChangeModelContent(function() {
          evalutate(editor.getValue());
        });

        selectSample = function (index) {
          const sample = samples[index];
          editor.setValue(sample);
        }

        function getDefaultSample() {
          return samples[4];
        }

        editor.setValue(getDefaultSample());
      });
    </script>
  </body>
</html>
