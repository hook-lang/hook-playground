<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hook's Playground</title>
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  
    <style type="text/css">
      .output-content {
        background-color: #FAFAFA;
        color: #0C1E3F;
        font-family: monospace;
        font-size: medium;
        padding: 10px;
        width: 500px;
        height: 300px;
        overflow: scroll;
      }
    </style>
  
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img src="resource/logo.png" alt="Logo" width="30" height="24">
        </a>
        <div class="fw-lighter">
          <div class="me-auto mb-2 mb-lg-0"></div>
          <div>Version 0.1.0</div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row align-items-start">

        <div class="col">

          <div class="container-fluid">
            <div class="row" style="margin-top: 1rem; margin-bottom: 1rem">
              <div class="col font-monospace">
                Source
              </div>
              <div class="col">
              </div>
              <div class="col">
                <div class="dropdown text-end">
                  <button id="samples" class="btn text-bg-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Samples
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="selectSample(0)">Binary search</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(1)">Factorial</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(2)">Fibonnaci</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(3)">Fizz buzz</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(4)">Hello, world!</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(5)">Knuth shuffle</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(6)">Mandelbrot set</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(7)">Quicksort</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(8)">Rule 110</a></li>
                    <li><a class="dropdown-item" href="#" onclick="selectSample(9)">Tower of Hanoi</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div id="source" style="height: 100vh"></div>
              </div>
            </div>
          </div>

        </div>

        <div class="col">

          <div class="container-fluid">
            <div class="row" style="margin-top: 1rem; margin-bottom: 1rem">
              <div class="col font-monospace">
                Output
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div>
                  <pre id="output" class="output-content" style="height: 100vh; width: 45vw"></pre>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>

    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="node_modules/monaco-editor/min/vs/loader.js"></script>

    <script>
      function getTokensProvider() {
        return {
          defaultToken: 'invalid',

          keywords: [
              'as',
              'break',
              'continue',
              'del',
              'do',
              'else',
              'false',
              'fn',
              'for',
              'foreach',
              'from',
              'if',
              'if!',
              'in',
              'loop',
              'match',
              'mut',
              'nil',
              'return',
              'struct',
              'true',
              'use',
              'val',
              'while',
              'while!',
          ],

          typeKeywords: [],

          operators: [
              '..',
              '.',
              '|=',
              '||',
              '|',
              '^=',
              '^',
              '&=',
              '&&',
              '&',
              '=>',
              '==',
              '=',
              '!=',
              '!',
              '>=',
              '>>=',
              '>>',
              '>',
              '<=',
              '<<=',
              '<<',
              '<',
              '+=',
              '++',
              '+',
              '-=',
              '--',
              '-',
              '*=',
              '*',
              '/=',
              '/',
              '~/=',
              '~/',
              '~',
              '%=',
              '%',
          ],

          symbols: /[=><!~?:&|+\-*/^%]+/,

          escapes: /\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,

          tokenizer: {
              root: [
                  // identifiers and keywords
                  [
                      /[a-z_$][\w$]*/,
                      {
                          cases: {
                              '@typeKeywords': 'keyword',
                              '@keywords': 'keyword',
                              '@default': 'identifier',
                          },
                      },
                  ],

                  [/[A-Z][\w$]*/, 'type.identifier'], // to show class names nicely

                  // whitespace
                  {include: '@whitespace'},

                  // delimiters and operators
                  [/[{}()[\]]/, '@brackets'],
                  [/[<>](?!@symbols)/, '@brackets'],
                  [
                      /@symbols/,
                      {
                          cases: {
                              '@operators': 'operator',
                              '@default': '',
                          },
                      },
                  ],

                  // numbers
                  [/\d*\.\d+([eE][-+]?\d+)?[fFdD]?/, 'number.float'],
                  [/0[xX][0-9a-fA-F_]*[0-9a-fA-F][Ll]?/, 'number.hex'],
                  [/0o[0-7_]*[0-7][Ll]?/, 'number.octal'],
                  [/0[bB][0-1_]*[0-1][Ll]?/, 'number.binary'],
                  [/\d+/, 'number'],

                  // delimiter: after number because of .\d floats
                  [/[;,.]/, 'delimiter'],

                  // strings
                  [/"([^"\\]|\\.)*$/, 'string.invalid'], // non-teminated string
                  [/c?\\\\.*$/, 'string'],
                  [/c?"/, 'string', '@string'],

                  // characters
                  [/'[^\\']'/, 'string'],
                  [/(')(@escapes)(')/, ['string', 'string.escape', 'string']],
                  [/'/, 'string.invalid'],
              ],

              whitespace: [
                  [/[ \r\n]+/, 'white'],
                  [/\/\*/, 'comment', '@comment'],
                  [/\/\+/, 'comment', '@comment'],
                  [/\/\/.*$/, 'comment'],
                  [/\t/, 'comment.invalid'],
              ],

              comment: [
                  [/[^/*]+/, 'comment'],
                  [/\/\*/, 'comment.invalid'],
                  [/[/*]/, 'comment'],
              ],

              string: [
                  [/[^\\"]+/, 'string'],
                  [/@escapes/, 'string.escape'],
                  [/\\./, 'string.escape.invalid'],
                  [/"/, 'string', '@pop'],
              ],
          },
        };
      }

      var samples = [
        "",
        "",
        "",
        "",
        "",
        "// Knuth shuffle",
        "// Mandelbrot set",
        "// Quicksort",
        "// Rule 110",
        "// Tower of Hanoi"
      ];

      samples[0] = "\/\/ Binary search\n"
                 + "\n"
                 + "fn binary_search(arr, key) {\n"
                 + "  mut low = 0;\n"
                 + "  mut high = len(arr) - 1;\n"
                 + "  while (low <= high) {\n"
                 + "    val middle = to_int((low + high) / 2);\n"
                 + "    val cmp = compare(key, arr[middle]);\n"
                 + "    if (cmp > 0) {\n"
                 + "      low = middle + 1;\n"
                 + "      continue;\n"
                 + "    }\n"
                 + "    if (cmp < 0) {\n"
                 + "      high = middle - 1;\n"
                 + "      continue;\n"
                 + "    }\n"
                 + "    return middle;\n"
                 + "  }\n"
                 + "  return -1;\n"
                 + "}\n"
                 + "\n"
                 + "val arr = [ -1, 0, 3, 5, 9, 12 ];\n"
                 + "println(binary_search(arr, 9));";

      samples[1] = "\/\/ Factorial\n"
                  + "\n"
                  + "fn factorial(n) {\n"
                  + "  if (n == 0)\n"
                  + "    return 1;\n"
                  + "  return n * factorial(n - 1);\n"
                  + "}\n"
                  + "\n"
                  + "println(factorial(8));";

      samples[2] = "\/\/ Fibonnaci\n"
                  + "\n"
                  + "fn fibonnaci(n) {\n"
                  + "  if (n < 2)\n"
                  + "    return n;\n"
                  + "  return fibonnaci(n - 1) + fibonnaci(n - 2);\n"
                  + "}\n"
                  + "\n"
                  + "println(fibonnaci(8));";

      samples[3] = "\/\/ Fizz buzz\n"
                  + "\n"
                  + "foreach (i in 1 .. 10) {\n"
                  + "  if (i % 3 == 0 && i % 5 == 0) {\n"
                  + "    println(\"FizzBuzz\");\n"
                  + "    continue;\n"
                  + "  }\n"
                  + "  if (i % 3 == 0) {\n"
                  + "    println(\"Fizz\");\n"
                  + "    continue;\n"
                  + "  }\n"
                  + "  if (i % 5 == 0) {\n"
                  + "    println(\"Buzz\");\n"
                  + "    continue;\n"
                  + "  }\n"
                  + "  println(i);\n"
                  + "}";

      samples[4] = "\/\/ Hello, world\n"
                 + "\n"
                 + "println(\"Hello, world!\");";

      var selectSample;

      function prepareRequestBody(source) {
        return {
          source: source,
          options: {
            userArguments: "",
            compilerOptions: {
              skipAsm: true
            },
            filters: {
              binaryObject: false,
              binary: false,
              execute: true,
              intel: true,
              demangle: true,
              labels: false,
              directives: false,
              commentOnly: false,
              trim: false
            },
            tools: [
            ],
            libraries: [
            ]
          },
          lang: "hook",
          files: [
          ],
          bypassCache: false,
          allowStoreCodeDebug: true
        };
      }

      function handleResponseBody(data) {
        const execResult = data.execResult;
        const out = execResult.code == 0 ? execResult.stdout : execResult.stderr;
        let text = "";
        for (let i = 0; i < out.length; i++) {
          const line = out[i];
          text += `${line.text}\n`;
        }
        return text;
      }

      function doRequest(body, callback) {
        const url = "https://godbolt.org/api/compiler/hook010/compile";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(body)
        })
          .then(response => response.json())
          .then(data => callback(data))
          .catch(error => console.error(error));
      }

      function evalutate(source) {
        const body = prepareRequestBody(source);
        doRequest(body, function(data) {
          const text = handleResponseBody(data);
          const output = document.getElementById("output");
          output.innerHTML = text;
        });
      }

      require.config({
        paths: {
          vs: "node_modules/monaco-editor/min/vs"
        }
      });

      require(["vs/editor/editor.main"], function () {

        monaco.languages.register({ id: "hook" });
        monaco.languages.setMonarchTokensProvider("hook", getTokensProvider());

        var editor = monaco.editor.create(document.getElementById("source"), {
          language: "hook"
        });

        editor.onDidChangeModelContent(function() {
          evalutate(editor.getValue());
        });

        selectSample = function (index) {
          const sample = samples[index];
          editor.setValue(sample);
        }

        function getDefaultSample() {
          return samples[4];
        }

        editor.setValue(getDefaultSample());
      });
    </script>
  </body>
</html>
